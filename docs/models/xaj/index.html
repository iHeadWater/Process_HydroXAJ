<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="http://127.0.0.1:8000/C%3A/Users/k6789/IdeaProjects/Process_HydroXAJ/docs/models/xaj/" />
      <link rel="shortcut icon" href="../../../../../../../../img/favicon.ico" />
    <title>xaj - Hydro Models Docs</title>
    <link rel="stylesheet" href="../../../../../../../../css/theme.css" />
    <link rel="stylesheet" href="../../../../../../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../../../../../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "xaj";
        var mkdocs_page_input_path = "C:\\Users\\k6789\\IdeaProjects\\Process_HydroXAJ\\docs\\models\\xaj.md";
        var mkdocs_page_url = "/C%3A/Users/k6789/IdeaProjects/Process_HydroXAJ/docs/models/xaj/";
      </script>
    
    <script src="../../../../../../../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../../../../../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../../../../../../.." class="icon icon-home"> Hydro Models Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../../../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              
                      <p class="caption"><span class="caption-text">app</span></p>
              
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../app/calibrate_xaj/">calibrate_xaj</a>
                  </li>
              </ul>
              
                      <p class="caption"><span class="caption-text">calibrate</span></p>
              
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../calibrate/calibrate_ga/">calibrate_ga</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../calibrate/calibrate_sceua/">calibrate_sceua</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../calibrate/stat/">stat</a>
                  </li>
              </ul>
              
                      <p class="caption"><span class="caption-text">models</span></p>
              
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../gr4j/">gr4j</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hymod/">hymod</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">xaj</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../xaj_river/">xaj_river</a>
                  </li>
              </ul>
              
                      <p class="caption"><span class="caption-text">utils</span></p>
              
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../utils/hydro_utils/">hydro_utils</a>
                  </li>
              </ul>
              
                      <p class="caption"><span class="caption-text">visual</span></p>
              
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../visual/pyspot_plots/">pyspot_plots</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../../..">Hydro Models Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../../../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>models &raquo;</li><li>xaj</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <div class="doc doc-object doc-module">


<a id="hydromodel.models.xaj"></a>
  <div class="doc doc-contents first">
  
      <p>Core code for XinAnJiang model</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.calculate_evap" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Three-layers evaporation model from "Watershed Hydrologic Simulation" written by Prof. RenJun Zhao.
The book is Chinese, and its name is 《流域水文模拟》;
The three-layers evaporation model is described in Page 76;
The method is same with that in Page 22-23 in "Hydrologic Forecasting (5-th version)" written by Prof. Weimin Bao.
This book's Chinese name is 《水文预报》</p>
<h4 id="hydromodel.models.xaj.calculate_evap--parameters">Parameters</h4>
<p>lm
    average soil moisture storage capacity of lower layer
c
    coefficient of deep layer
wu0
    initial soil moisture of upper layer; update in each time step
wl0
    initial soil moisture of lower layer; update in each time step
prcp
    basin mean precipitation
pet
    potential evapotranspiration</p>
<h4 id="hydromodel.models.xaj.calculate_evap--returns">Returns</h4>
<p>tuple[np.array,np.array,np.array]
    eu/el/ed are evaporation from upper/lower/deeper layer, respectively</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Three-layers evaporation model from &quot;Watershed Hydrologic Simulation&quot; written by Prof. RenJun Zhao.</span>
<span class="sd">    The book is Chinese, and its name is 《流域水文模拟》;</span>
<span class="sd">    The three-layers evaporation model is described in Page 76;</span>
<span class="sd">    The method is same with that in Page 22-23 in &quot;Hydrologic Forecasting (5-th version)&quot; written by Prof. Weimin Bao.</span>
<span class="sd">    This book&#39;s Chinese name is 《水文预报》</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of lower layer</span>
<span class="sd">    c</span>
<span class="sd">        coefficient of deep layer</span>
<span class="sd">    wu0</span>
<span class="sd">        initial soil moisture of upper layer; update in each time step</span>
<span class="sd">    wl0</span>
<span class="sd">        initial soil moisture of lower layer; update in each time step</span>
<span class="sd">    prcp</span>
<span class="sd">        basin mean precipitation</span>
<span class="sd">    pet</span>
<span class="sd">        potential evapotranspiration</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.array,np.array,np.array]</span>
<span class="sd">        eu/el/ed are evaporation from upper/lower/deeper layer, respectively</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span>
        <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">,</span>
            <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">*</span> <span class="n">wl0</span> <span class="o">/</span> <span class="n">lm</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">wl0</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.calculate_prcp_runoff" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Calculates the amount of runoff generated from rainfall after entering the underlying surface.</p>
<p>Same in "Watershed Hydrologic Simulation" and "Hydrologic Forecasting (5-th version)"</p>
<h4 id="hydromodel.models.xaj.calculate_prcp_runoff--parameters">Parameters</h4>
<p>b
    B; exponent coefficient
im
    IMP; imperiousness coefficient
wm
    average soil moisture storage capacity
w0
    initial soil moisture
pe
    net precipitation</p>
<h4 id="hydromodel.models.xaj.calculate_prcp_runoff--returns">Returns</h4>
<p>tuple[np.array,np.array]
    r -- runoff; r_im -- runoff of impervious part</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the amount of runoff generated from rainfall after entering the underlying surface.</span>

<span class="sd">    Same in &quot;Watershed Hydrologic Simulation&quot; and &quot;Hydrologic Forecasting (5-th version)&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    b</span>
<span class="sd">        B; exponent coefficient</span>
<span class="sd">    im</span>
<span class="sd">        IMP; imperiousness coefficient</span>
<span class="sd">    wm</span>
<span class="sd">        average soil moisture storage capacity</span>
<span class="sd">    w0</span>
<span class="sd">        initial soil moisture</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.array,np.array]</span>
<span class="sd">        r -- runoff; r_im -- runoff of impervious part</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">wmm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w0</span> <span class="o">/</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;Please check if w0&gt;wm or b is a negative value!&quot;</span><span class="p">)</span>
    <span class="n">r_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span> <span class="o">+</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">wmm</span><span class="p">,</span>
            <span class="c1"># 1e-5 is a precision which we set to guarantee float&#39;s calculation is correct</span>
            <span class="n">pe</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="n">wmm</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="o">/</span> <span class="n">wmm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span>
            <span class="n">pe</span> <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_cal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># separate impervious part with the other</span>
    <span class="n">r_im_cal</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="n">im</span>
    <span class="n">r_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_im_cal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_im</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.calculate_w_storage" class="doc doc-heading">
<code class="highlight language-python"><span class="n">calculate_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Update the soil moisture values of the three layers.</p>
<p>According to the equation 2.60 in the book《水文预报》</p>
<h4 id="hydromodel.models.xaj.calculate_w_storage--parameters">Parameters</h4>
<p>um
    average soil moisture storage capacity of the upper layer
lm
    average soil moisture storage capacity of the lower layer
dm
    average soil moisture storage capacity of the deep layer
wu0
    initial values of soil moisture in upper layer
wl0
    initial values of soil moisture in lower layer
wd0
    initial values of soil moisture in deep layer
eu
    evaporation of the upper layer; it isn't used in this function
el
    evaporation of the lower layer
ed
    evaporation of the deep layer
pe
    net precipitation; it is able to be negative value in this function
r
    runoff</p>
<h4 id="hydromodel.models.xaj.calculate_w_storage--returns">Returns</h4>
<p>tuple[np.array,np.array,np.array]
    wu,wl,wd -- soil moisture in upper, lower and deep layer</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_w_storage</span><span class="p">(</span>
    <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the soil moisture values of the three layers.</span>

<span class="sd">    According to the equation 2.60 in the book《水文预报》</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    um</span>
<span class="sd">        average soil moisture storage capacity of the upper layer</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of the lower layer</span>
<span class="sd">    dm</span>
<span class="sd">        average soil moisture storage capacity of the deep layer</span>
<span class="sd">    wu0</span>
<span class="sd">        initial values of soil moisture in upper layer</span>
<span class="sd">    wl0</span>
<span class="sd">        initial values of soil moisture in lower layer</span>
<span class="sd">    wd0</span>
<span class="sd">        initial values of soil moisture in deep layer</span>
<span class="sd">    eu</span>
<span class="sd">        evaporation of the upper layer; it isn&#39;t used in this function</span>
<span class="sd">    el</span>
<span class="sd">        evaporation of the lower layer</span>
<span class="sd">    ed</span>
<span class="sd">        evaporation of the deep layer</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation; it is able to be negative value in this function</span>
<span class="sd">    r</span>
<span class="sd">        runoff</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[np.array,np.array,np.array]</span>
<span class="sd">        wu,wl,wd -- soil moisture in upper, lower and deep layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pe&gt;0: the upper soil moisture was added firstly, then lower layer, and the final is deep layer</span>
    <span class="c1"># pe&lt;=0: no additional water, just remove evapotranspiration,</span>
    <span class="c1"># but note the case: e &gt;= p &gt; 0</span>
    <span class="c1"># (1) if wu0 + p &gt; e, then e = eu (2) else, wu must be zero</span>
    <span class="n">wu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">um</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">um</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># calculate wd before wl because it is easier to cal using where statement</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">um</span> <span class="o">-</span> <span class="n">lm</span><span class="p">,</span> <span class="n">wd0</span><span class="p">),</span>
        <span class="n">wd0</span> <span class="o">-</span> <span class="n">ed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># water balance (equation 2.2 in Page 13, also shown in Page 23)</span>
    <span class="c1"># if wu0 + p &gt; e, then e = eu; else p must be used in upper layer,</span>
    <span class="c1"># so no matter what the case is, el didn&#39;t include p, neither ed</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">wu</span> <span class="o">-</span> <span class="n">wd</span><span class="p">,</span> <span class="n">wl0</span> <span class="o">-</span> <span class="n">el</span><span class="p">)</span>
    <span class="c1"># the water storage should be in reasonable range</span>
    <span class="n">wu_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">um</span><span class="p">)</span>
    <span class="n">wl_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span>
    <span class="n">wd_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wu_</span><span class="p">,</span> <span class="n">wl_</span><span class="p">,</span> <span class="n">wd_</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.generation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generation</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wd0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Single-step runoff generation in XAJ.</p>
<h4 id="hydromodel.models.xaj.generation--parameters">Parameters</h4>
<p>p_and_e
    precipitation and potential evapotranspiration
k
    ratio of potential evapotranspiration to reference crop evaporation
b
    exponent parameter
um
    average soil moisture storage capacity of the upper layer
lm
    average soil moisture storage capacity of the lower layer
dm
    average soil moisture storage capacity of the deep layer
im
    impermeability coefficient
c
    coefficient of deep layer
wu0
    initial values of soil moisture in upper layer
wl0
    initial values of soil moisture in lower layer
wd0
    initial values of soil moisture in deep layer</p>
<h4 id="hydromodel.models.xaj.generation--returns">Returns</h4>
<p>tuple[tuple, tuple]
    (r, rim, e, pe), (wu, wl, wd); all variables are np.array</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generation</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wd0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Single-step runoff generation in XAJ.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        precipitation and potential evapotranspiration</span>
<span class="sd">    k</span>
<span class="sd">        ratio of potential evapotranspiration to reference crop evaporation</span>
<span class="sd">    b</span>
<span class="sd">        exponent parameter</span>
<span class="sd">    um</span>
<span class="sd">        average soil moisture storage capacity of the upper layer</span>
<span class="sd">    lm</span>
<span class="sd">        average soil moisture storage capacity of the lower layer</span>
<span class="sd">    dm</span>
<span class="sd">        average soil moisture storage capacity of the deep layer</span>
<span class="sd">    im</span>
<span class="sd">        impermeability coefficient</span>
<span class="sd">    c</span>
<span class="sd">        coefficient of deep layer</span>
<span class="sd">    wu0</span>
<span class="sd">        initial values of soil moisture in upper layer</span>
<span class="sd">    wl0</span>
<span class="sd">        initial values of soil moisture in lower layer</span>
<span class="sd">    wd0</span>
<span class="sd">        initial values of soil moisture in deep layer</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tuple, tuple]</span>
<span class="sd">        (r, rim, e, pe), (wu, wl, wd); all variables are np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure physical variables&#39; value ranges are correct</span>
    <span class="n">prcp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># get potential evapotranspiration</span>
    <span class="n">pet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># wm</span>
    <span class="n">wm</span> <span class="o">=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">dm</span>
    <span class="k">if</span> <span class="n">wu0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># just an initial value</span>
        <span class="n">wu0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">um</span>
    <span class="k">if</span> <span class="n">wl0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wl0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">lm</span>
    <span class="k">if</span> <span class="n">wd0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wd0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">dm</span>
    <span class="n">w0_</span> <span class="o">=</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span>

    <span class="c1"># w0 need locate in correct range so that following calculation could be right</span>
    <span class="c1"># To make sure float data&#39;s calculation is correct, we&#39;d better minus a precision (1e-5)</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">w0_</span><span class="p">,</span> <span class="n">wm</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="c1"># Calculate the amount of evaporation from storage</span>
    <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">+</span> <span class="n">el</span> <span class="o">+</span> <span class="n">ed</span>

    <span class="c1"># Calculate the runoff generated by net precipitation</span>
    <span class="n">prcp_difference</span> <span class="o">=</span> <span class="n">prcp</span> <span class="o">-</span> <span class="n">e</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">prcp_difference</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">rim</span> <span class="o">=</span> <span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
    <span class="c1"># Update wu, wl, wd</span>
    <span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span> <span class="o">=</span> <span class="n">calculate_w_storage</span><span class="p">(</span>
        <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">prcp_difference</span><span class="p">,</span> <span class="n">r</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.linear_reservoir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Linear reservoir's release function</p>
<h4 id="hydromodel.models.xaj.linear_reservoir--parameters">Parameters</h4>
<p>x
    the input to the linear reservoir
weight
    the coefficient of linear reservoir
last_y
    the output of last period</p>
<h4 id="hydromodel.models.xaj.linear_reservoir--returns">Returns</h4>
<p>np.array
    one-step forward result</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear reservoir&#39;s release function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        the input to the linear reservoir</span>
<span class="sd">    weight</span>
<span class="sd">        the coefficient of linear reservoir</span>
<span class="sd">    last_y</span>
<span class="sd">        the output of last period</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        one-step forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight</span>
    <span class="k">if</span> <span class="n">last_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">last_y</span> <span class="o">+</span> <span class="n">weight1</span> <span class="o">*</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.sources" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Divide the runoff to different sources</p>
<p>We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:
"Analysis of parameters of the XinAnJiang model". Its Chinese name is &lt;&lt;新安江模型参数的分析&gt;&gt;,
which could be found by searching in "Baidu Xueshu".
The module's code can also be found in "Watershed Hydrologic Simulation" (WHS) Page 174.
It is nearly same with that in "Hydrologic Forecasting" (HF) Page 148-149
We use the period average runoff as input and the unit period is day so we don't need to difference it as books show</p>
<p>We also provide code for formula from《水文预报》 the fifth version. Page 40-41 and 150-151;
the procedures in 《工程水文学》 the third version are different we also provide.
they are in the "sources5mm" function.</p>
<h4 id="hydromodel.models.xaj.sources--parameters">Parameters</h4>
<p>pe
    net precipitation
r
    runoff from xaj_generation
sm
    areal mean free water capacity of the surface layer
ex
    exponent of the free water capacity curve
ki
    outflow coefficients of the free water storage to interflow relationships
kg
    outflow coefficients of the free water storage to groundwater relationships
s0
    free water capacity of last period
fr0
    runoff area of last period</p>
<h4 id="hydromodel.models.xaj.sources--return">Return</h4>
<p>tuple[tuple, tuple]
    rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff;
    s1 -- final free water capacity;
    all variables are numpy array</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide the runoff to different sources</span>

<span class="sd">    We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:</span>
<span class="sd">    &quot;Analysis of parameters of the XinAnJiang model&quot;. Its Chinese name is &lt;&lt;新安江模型参数的分析&gt;&gt;,</span>
<span class="sd">    which could be found by searching in &quot;Baidu Xueshu&quot;.</span>
<span class="sd">    The module&#39;s code can also be found in &quot;Watershed Hydrologic Simulation&quot; (WHS) Page 174.</span>
<span class="sd">    It is nearly same with that in &quot;Hydrologic Forecasting&quot; (HF) Page 148-149</span>
<span class="sd">    We use the period average runoff as input and the unit period is day so we don&#39;t need to difference it as books show</span>

<span class="sd">    We also provide code for formula from《水文预报》 the fifth version. Page 40-41 and 150-151;</span>
<span class="sd">    the procedures in 《工程水文学》 the third version are different we also provide.</span>
<span class="sd">    they are in the &quot;sources5mm&quot; function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation</span>
<span class="sd">    r</span>
<span class="sd">        runoff from xaj_generation</span>
<span class="sd">    sm</span>
<span class="sd">        areal mean free water capacity of the surface layer</span>
<span class="sd">    ex</span>
<span class="sd">        exponent of the free water capacity curve</span>
<span class="sd">    ki</span>
<span class="sd">        outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">    kg</span>
<span class="sd">        outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">    s0</span>
<span class="sd">        free water capacity of last period</span>
<span class="sd">    fr0</span>
<span class="sd">        runoff area of last period</span>

<span class="sd">    Return</span>
<span class="sd">    ------------</span>
<span class="sd">    tuple[tuple, tuple]</span>
<span class="sd">        rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff;</span>
<span class="sd">        s1 -- final free water capacity;</span>
<span class="sd">        all variables are numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># maximum free water storage capacity in a basin</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sm</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="c1"># For free water storage, because s is related to fr and s0 and fr0 are both values of last period,</span>
    <span class="c1"># we have to trans the initial value of s from last period to this one.</span>
    <span class="c1"># both WHS（流域水文模拟）&#39;s sample code and HF（水文预报） use s = fr0 * s0 / fr.</span>
    <span class="c1"># I think they both think free water reservoir as a cubic tank. Its height is s and area of bottom rectangle is fr</span>
    <span class="c1"># but the problem is we will have a cubic tank with varying bottom and height, and fixed boundary (sm is fixed)</span>
    <span class="c1"># -&gt; so strange !!! I think maybe 2-sources xaj is more interpretable</span>
    <span class="c1"># especially when r=0 then fr0=0, the free water cannot disappear immediately, so we have to use s = s0, fr=fr0</span>
    <span class="c1"># fr&#39;s formula could be found in Eq. 9 in &quot;Analysis of parameters of the XinAnJiang model&quot;,</span>
    <span class="c1"># Here our r doesn&#39;t include rim, so there is no need to remove rim from r; this is also the method in 《水文预报》（HF）</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">r</span> <span class="o">/</span> <span class="n">pe</span><span class="p">,</span> <span class="n">fr0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;Please check pe&#39;s data! there may be 0.0&quot;</span><span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">fr0</span> <span class="o">*</span> <span class="n">s0</span> <span class="o">/</span> <span class="n">fr</span><span class="p">,</span> <span class="n">sm</span> <span class="o">-</span> <span class="n">precision</span><span class="p">)</span>
    <span class="n">au</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error： NaN values detected. Try set clip function or check your data!!!&quot;</span>
        <span class="p">)</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span> <span class="o">+</span> <span class="n">au</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">,</span>
            <span class="c1"># equation 2-85 in HF</span>
            <span class="c1"># set precision to guarantee float data&#39;s calculation is correct</span>
            <span class="n">fr</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">pe</span>
                <span class="o">-</span> <span class="n">sm</span>
                <span class="o">+</span> <span class="n">ss</span>
                <span class="o">+</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pe</span> <span class="o">+</span> <span class="n">au</span><span class="p">,</span> <span class="n">ms</span> <span class="o">-</span> <span class="n">precision</span><span class="p">)</span> <span class="o">/</span> <span class="n">ms</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="c1"># equation 2-86 in HF</span>
            <span class="n">fr</span> <span class="o">*</span> <span class="p">(</span><span class="n">pe</span> <span class="o">+</span> <span class="n">ss</span> <span class="o">-</span> <span class="n">sm</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">a_max</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
    <span class="c1"># equation 2-87 in HF, some free water leave, so we update free water storage</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="n">rs</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;Please check fr&#39;s data! there may be 0.0&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
    <span class="c1"># equation 2-88 in HF, next interflow and ground water will be released from the updated free water storage</span>
    <span class="c1"># We use the period average runoff as input and the general unit period is day.</span>
    <span class="c1"># Hence, we directly use ki and kg rather than ki_{Δt} in books.</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">kg</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="c1"># equation 2-89 in HF; although it looks different with that in WHS, they are actually same</span>
    <span class="c1"># Finally, calculate the final free water storage</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ki</span> <span class="o">-</span> <span class="n">kg</span><span class="p">),</span> <span class="n">a_min</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">a_max</span><span class="o">=</span><span class="n">sm</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.sources5mm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sources5mm</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">runoff</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_interval_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s1">&#39;ShuiWenYuBao&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Divide the runoff to different sources according to books -- 《水文预报》 5th edition and 《工程水文学》 3rd edition</p>
<h4 id="hydromodel.models.xaj.sources5mm--parameters">Parameters</h4>
<p>pe
    net precipitation
runoff
    runoff from xaj_generation
sm
    areal mean free water capacity of the surface layer
ex
    exponent of the free water capacity curve
ki
    outflow coefficients of the free water storage to interflow relationships
kg
    outflow coefficients of the free water storage to groundwater relationships
s0
    initial free water capacity
fr0
    initial area of generation
time_interval_hours
    由于Ki、Kg、Ci、Cg都是以24小时为时段长定义的，需根据时段长转换
book
    the methods in 《水文预报》 5th edition and 《工程水文学》 3rd edition are different,
    hence, both are provided, and the default is the former -- "ShuiWenYuBao";
    the other one is "GongChengShuiWenXue"</p>
<h4 id="hydromodel.models.xaj.sources5mm--returns">Returns</h4>
<p>tuple[tuple, tuple]
    rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;
    (fr_ds[-1], s_ds[-1]): state variables' final value;
    all variables are numpy array</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sources5mm</span><span class="p">(</span>
    <span class="n">pe</span><span class="p">,</span>
    <span class="n">runoff</span><span class="p">,</span>
    <span class="n">sm</span><span class="p">,</span>
    <span class="n">ex</span><span class="p">,</span>
    <span class="n">ki</span><span class="p">,</span>
    <span class="n">kg</span><span class="p">,</span>
    <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">time_interval_hours</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">book</span><span class="o">=</span><span class="s2">&quot;ShuiWenYuBao&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divide the runoff to different sources according to books -- 《水文预报》 5th edition and 《工程水文学》 3rd edition</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pe</span>
<span class="sd">        net precipitation</span>
<span class="sd">    runoff</span>
<span class="sd">        runoff from xaj_generation</span>
<span class="sd">    sm</span>
<span class="sd">        areal mean free water capacity of the surface layer</span>
<span class="sd">    ex</span>
<span class="sd">        exponent of the free water capacity curve</span>
<span class="sd">    ki</span>
<span class="sd">        outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">    kg</span>
<span class="sd">        outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">    s0</span>
<span class="sd">        initial free water capacity</span>
<span class="sd">    fr0</span>
<span class="sd">        initial area of generation</span>
<span class="sd">    time_interval_hours</span>
<span class="sd">        由于Ki、Kg、Ci、Cg都是以24小时为时段长定义的，需根据时段长转换</span>
<span class="sd">    book</span>
<span class="sd">        the methods in 《水文预报》 5th edition and 《工程水文学》 3rd edition are different,</span>
<span class="sd">        hence, both are provided, and the default is the former -- &quot;ShuiWenYuBao&quot;;</span>
<span class="sd">        the other one is &quot;GongChengShuiWenXue&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[tuple, tuple]</span>
<span class="sd">        rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;</span>
<span class="sd">        (fr_ds[-1], s_ds[-1]): state variables&#39; final value;</span>
<span class="sd">        all variables are numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 由于Ki、Kg都是以24小时为时段长定义的，需根据时段长转换</span>
    <span class="n">hours_per_day</span> <span class="o">=</span> <span class="mi">24</span>
    <span class="c1"># 非整除情况，时段+1</span>
    <span class="n">residue_temp</span> <span class="o">=</span> <span class="n">hours_per_day</span> <span class="o">%</span> <span class="n">time_interval_hours</span>
    <span class="k">if</span> <span class="n">residue_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">residue_temp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">period_num_1d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_per_day</span> <span class="o">/</span> <span class="n">time_interval_hours</span><span class="p">)</span> <span class="o">+</span> <span class="n">residue_temp</span>
    <span class="c1"># 当kss+kg&gt;1时，根式为偶数运算时，kss_period会成为复数，这里会报错；另外注意分母可能为0，kss不可取0</span>
    <span class="c1"># 对kss+kg的取值进行限制，也是符合物理意义的，地下水出流不能超过自身的蓄水。</span>
    <span class="n">kss_period</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">period_num_1d</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span><span class="p">)</span>
    <span class="n">kg_period</span> <span class="o">=</span> <span class="n">kss_period</span> <span class="o">*</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span>

    <span class="c1"># 流域最大点自由水蓄水容量深</span>
    <span class="n">smm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.60</span> <span class="o">*</span> <span class="n">sm</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">runoff</span> <span class="o">/</span> <span class="n">pe</span><span class="p">,</span> <span class="n">fr0</span><span class="p">)</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 净雨分5mm一段进行计算，因为计算时在FS/FR ~ SMF&#39;关系图上开展，即计算在产流面积上开展，所以用PE做净雨.分段为了差分计算更精确。</span>
    <span class="k">if</span> <span class="n">runoff</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">residue_temp</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">%</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">residue_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">residue_temp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">runoff</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">residue_temp</span>
    <span class="c1"># 整除了就是5mm，不整除就少一些，差分每段小了也挺好</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">kss_d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">kss_period</span> <span class="o">+</span> <span class="n">kg_period</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="n">kg_period</span> <span class="o">/</span> <span class="n">kss_period</span>
    <span class="p">)</span>
    <span class="n">kg_d</span> <span class="o">=</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">kg_period</span> <span class="o">/</span> <span class="n">kss_period</span>

    <span class="n">rs</span> <span class="o">=</span> <span class="n">rss</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">s_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fr_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># 因为产流面积随着自由水蓄水容量的变化而变化，每5mm净雨对应的产流面积肯定是不同的，因此fr是变化的</span>
        <span class="n">fr0_d</span> <span class="o">=</span> <span class="n">fr_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">s0_d</span> <span class="o">=</span> <span class="n">s_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">fr_d</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">s_d</span> <span class="o">=</span> <span class="n">fr0_d</span> <span class="o">*</span> <span class="n">s0_d</span> <span class="o">/</span> <span class="n">fr_d</span>

        <span class="k">if</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;ShuiWenYuBao&quot;</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">smm</span>
            <span class="k">if</span> <span class="n">s_d</span> <span class="o">&gt;</span> <span class="n">sm</span><span class="p">:</span>
                <span class="n">s_d</span> <span class="o">=</span> <span class="n">sm</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s_d</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">pen</span> <span class="o">+</span> <span class="n">au</span> <span class="o">&gt;=</span> <span class="n">ms</span><span class="p">:</span>
                <span class="n">rs_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pen</span> <span class="o">+</span> <span class="n">s_d</span> <span class="o">-</span> <span class="n">sm</span><span class="p">)</span> <span class="o">*</span> <span class="n">fr_d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rs_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pen</span> <span class="o">-</span> <span class="n">sm</span> <span class="o">+</span> <span class="n">s_d</span> <span class="o">+</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pen</span> <span class="o">+</span> <span class="n">au</span><span class="p">)</span> <span class="o">/</span> <span class="n">ms</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">ex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">fr_d</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">+</span> <span class="p">(</span><span class="n">rn</span> <span class="o">-</span> <span class="n">rs_j</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr_d</span>
            <span class="n">rss_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">fr_d</span>
            <span class="n">rg_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kg_d</span> <span class="o">*</span> <span class="n">fr_d</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rss_j</span> <span class="o">+</span> <span class="n">rg_j</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;GongChengShuiWenXue&quot;</span><span class="p">:</span>
            <span class="n">smmf</span> <span class="o">=</span> <span class="n">smm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr_d</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ex</span><span class="p">))</span>
            <span class="n">smf</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
            <span class="c1"># 如果出现s_d&gt;smf的情况，说明s_d = fr0_d * s0_d / fr_d导致的计算误差不合理，需要进行修正。</span>
            <span class="k">if</span> <span class="n">s_d</span> <span class="o">&gt;</span> <span class="n">smf</span><span class="p">:</span>
                <span class="n">s_d</span> <span class="o">=</span> <span class="n">smf</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">s_d</span> <span class="o">/</span> <span class="n">smf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">pen</span> <span class="o">+</span> <span class="n">au</span> <span class="o">&gt;=</span> <span class="n">smmf</span><span class="p">:</span>
                <span class="n">rs_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pen</span> <span class="o">+</span> <span class="n">s_d</span> <span class="o">-</span> <span class="n">smf</span><span class="p">)</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">rss_j</span> <span class="o">=</span> <span class="n">smf</span> <span class="o">*</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">rg_j</span> <span class="o">=</span> <span class="n">smf</span> <span class="o">*</span> <span class="n">kg_d</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">s_d</span> <span class="o">=</span> <span class="n">smf</span> <span class="o">-</span> <span class="p">(</span><span class="n">rss_j</span> <span class="o">+</span> <span class="n">rg_j</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr_d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rs_j</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pen</span> <span class="o">-</span> <span class="n">smf</span> <span class="o">+</span> <span class="n">s_d</span> <span class="o">+</span> <span class="n">smf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pen</span> <span class="o">+</span> <span class="n">au</span><span class="p">)</span> <span class="o">/</span> <span class="n">smmf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">ex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">rss_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pen</span> <span class="o">-</span> <span class="n">rs_j</span> <span class="o">/</span> <span class="n">fr_d</span> <span class="o">+</span> <span class="n">s_d</span><span class="p">)</span> <span class="o">*</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">rg_j</span> <span class="o">=</span> <span class="p">(</span><span class="n">pen</span> <span class="o">-</span> <span class="n">rs_j</span> <span class="o">/</span> <span class="n">fr_d</span> <span class="o">+</span> <span class="n">s_d</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_d</span> <span class="o">*</span> <span class="n">fr_d</span>
                <span class="n">s_d</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">+</span> <span class="n">pen</span> <span class="o">-</span> <span class="p">(</span><span class="n">rs_j</span> <span class="o">+</span> <span class="n">rss_j</span> <span class="o">+</span> <span class="n">rg_j</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr_d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;We don&#39;t have this implementation! Please chose &#39;ShuiWenYuBao&#39; or &#39;GongChengShuiWenXue&#39;!!&quot;</span>
            <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">rs_j</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">rss</span> <span class="o">+</span> <span class="n">rss_j</span>
        <span class="n">rg</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">+</span> <span class="n">rg_j</span>
        <span class="c1"># 赋值s_d和fr_d到数组中，以给下一段做初值</span>
        <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_d</span><span class="p">)</span>
        <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr_d</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.uh_conv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uh_conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">uh_from_gamma</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Function for 1d-convolution calculation</p>
<h4 id="hydromodel.models.xaj.uh_conv--parameters">Parameters</h4>
<p>x
    x is a sequence-first variable; the dim of x is [seq, batch, feature=1];
    feature must be 1
uh_from_gamma
    unit hydrograph from uh_gamma; the dim: [len_uh, batch, feature=1];
    feature must be 1</p>
<h4 id="hydromodel.models.xaj.uh_conv--returns">Returns</h4>
<p>np.array
    convolution</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">uh_conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">uh_from_gamma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for 1d-convolution calculation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x</span>
<span class="sd">        x is a sequence-first variable; the dim of x is [seq, batch, feature=1];</span>
<span class="sd">        feature must be 1</span>
<span class="sd">    uh_from_gamma</span>
<span class="sd">        unit hydrograph from uh_gamma; the dim: [len_uh, batch, feature=1];</span>
<span class="sd">        feature must be 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        convolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">time_length</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">feature_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">feature_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;We only support one-dim convolution now!!!&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
        <span class="n">uh</span> <span class="o">=</span> <span class="n">uh_from_gamma</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">uh</span><span class="p">)[:</span><span class="n">time_length</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.uh_gamma" class="doc doc-heading">
<code class="highlight language-python"><span class="n">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model
The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</p>
<h4 id="hydromodel.models.xaj.uh_gamma--parameters">Parameters</h4>
<p>a
    shape parameter
theta
    timescale parameter
len_uh
    the time length of the unit hydrograph
Returns</p>
<hr />
<p>torch.Tensor
    the unit hydrograph, dim: [seq, batch, feature]</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model</span>
<span class="sd">    The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a</span>
<span class="sd">        shape parameter</span>
<span class="sd">    theta</span>
<span class="sd">        timescale parameter</span>
<span class="sd">    len_uh</span>
<span class="sd">        the time length of the unit hydrograph</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        the unit hydrograph, dim: [seq, batch, feature]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dims of a: time_seq (same all time steps), batch, feature=1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">len_uh</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;length of unit hydrograph should be smaller than the whole length of input&quot;</span>
        <span class="p">)</span>
    <span class="c1"># aa &gt; 0, here we set minimum 0.1 (min of a is 0, set when calling this func); First dimension of a is repeat</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="c1"># theta &gt; 0, here set minimum 0.5</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="c1"># len_f, batch, feature</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">len_uh</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="n">aa</span><span class="p">)</span>
    <span class="c1"># [len_f, m[1], m[2]]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">denominator</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">**</span> <span class="p">(</span><span class="n">aa</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># scale to 1 for each UH</span>
    <span class="k">return</span> <span class="n">w</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 id="hydromodel.models.xaj.xaj" class="doc doc-heading">
<code class="highlight language-python"><span class="n">xaj</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">warmup_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">route_method</span><span class="o">=</span><span class="s1">&#39;CSL&#39;</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;sources&#39;</span><span class="p">,</span> <span class="n">source_book</span><span class="o">=</span><span class="s1">&#39;ShuiWenYuBao&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>run XAJ model</p>
<h4 id="hydromodel.models.xaj.xaj--parameters">Parameters</h4>
<p>p_and_e
    prcp and pet; sequence-first (time is the first dim) 3-d np array: [time, basin, feature=2]
params
    parameters of XAJ model for basin(s);
    2-dim variable -- [basin, parameter]:
    the parameters are B IM UM LM DM C SM EX KI KG A THETA CI CG (notice the sequence)
return_state
    if True, return state values, mainly for warmup periods
kernel_size
    the length of unit hydrograph
warmup_length
    hydro models need a warm-up period to get good initial state values
route_method
    now we provide two ways: "CSL" (recession constant + lag time) and "MZ" (method from mizuRoute)
source_type
    default is "sources" and it will call "sources" function; the other is "sources5mm",
    and we will divide the runoff to some &lt;5mm pieces according to the books in this case
source_book
    When source_type is "sources5mm" there are two implementions for dividing sources,
    as the methods in "ShuiWenYuBao" and "GongChengShuiWenXue"" are different.
    Hence, both are provided, and the default is the former.</p>
<h4 id="hydromodel.models.xaj.xaj--returns">Returns</h4>
<p>Union[np.array, tuple]
    streamflow or (streamflow, states)</p>

      <details class="quote">
        <summary>Source code in <code>hydromodel\models\xaj.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">xaj</span><span class="p">(</span>
    <span class="n">p_and_e</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">route_method</span><span class="o">=</span><span class="s2">&quot;CSL&quot;</span><span class="p">,</span>
    <span class="n">source_type</span><span class="o">=</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span>
    <span class="n">source_book</span><span class="o">=</span><span class="s2">&quot;ShuiWenYuBao&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run XAJ model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p_and_e</span>
<span class="sd">        prcp and pet; sequence-first (time is the first dim) 3-d np array: [time, basin, feature=2]</span>
<span class="sd">    params</span>
<span class="sd">        parameters of XAJ model for basin(s);</span>
<span class="sd">        2-dim variable -- [basin, parameter]:</span>
<span class="sd">        the parameters are B IM UM LM DM C SM EX KI KG A THETA CI CG (notice the sequence)</span>
<span class="sd">    return_state</span>
<span class="sd">        if True, return state values, mainly for warmup periods</span>
<span class="sd">    kernel_size</span>
<span class="sd">        the length of unit hydrograph</span>
<span class="sd">    warmup_length</span>
<span class="sd">        hydro models need a warm-up period to get good initial state values</span>
<span class="sd">    route_method</span>
<span class="sd">        now we provide two ways: &quot;CSL&quot; (recession constant + lag time) and &quot;MZ&quot; (method from mizuRoute)</span>
<span class="sd">    source_type</span>
<span class="sd">        default is &quot;sources&quot; and it will call &quot;sources&quot; function; the other is &quot;sources5mm&quot;,</span>
<span class="sd">        and we will divide the runoff to some &lt;5mm pieces according to the books in this case</span>
<span class="sd">    source_book</span>
<span class="sd">        When source_type is &quot;sources5mm&quot; there are two implementions for dividing sources,</span>
<span class="sd">        as the methods in &quot;ShuiWenYuBao&quot; and &quot;GongChengShuiWenXue&quot;&quot; are different.</span>
<span class="sd">        Hence, both are provided, and the default is the former.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[np.array, tuple]</span>
<span class="sd">        streamflow or (streamflow, states)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># params</span>
    <span class="k">if</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;CSL&quot;</span><span class="p">:</span>
        <span class="n">param_ranges</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                <span class="s2">&quot;IM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                <span class="s2">&quot;UM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],</span>
                <span class="s2">&quot;LM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">],</span>
                <span class="s2">&quot;DM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">],</span>
                <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                <span class="s2">&quot;SM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
                <span class="s2">&quot;EX&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
                <span class="s2">&quot;KI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                <span class="s2">&quot;KG&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                <span class="s2">&quot;CS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>  <span class="c1"># unit is day</span>
                <span class="s2">&quot;CI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                <span class="s2">&quot;CG&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.998</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;MZ&quot;</span><span class="p">:</span>
        <span class="n">param_ranges</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                <span class="s2">&quot;IM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                <span class="s2">&quot;UM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">],</span>
                <span class="s2">&quot;LM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">],</span>
                <span class="s2">&quot;DM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">120.0</span><span class="p">],</span>
                <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                <span class="s2">&quot;SM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
                <span class="s2">&quot;EX&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
                <span class="s2">&quot;KI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                <span class="s2">&quot;KG&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.9</span><span class="p">],</span>
                <span class="s2">&quot;THETA&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
                <span class="s2">&quot;CI&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                <span class="s2">&quot;CG&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.998</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CS&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>
    <span class="n">xaj_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">um</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">kg</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="c1"># ki+kg should be smaller than 1; if not, we scale them</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki</span><span class="p">)</span>
    <span class="n">kg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;CSL&quot;</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;MZ&quot;</span><span class="p">:</span>
        <span class="c1"># we will use routing method from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CS&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">xaj_params</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>

    <span class="c1"># initialize state values</span>
    <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">xaj</span><span class="p">(</span>
            <span class="n">p_and_e_warmup</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">warmup_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">um</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lm</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dm</span><span class="p">)</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sm</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">qi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">qg0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># state_variables</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rss_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ris_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rgs_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="c1"># impevious part is pe * im</span>
        <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
        <span class="c1"># so for non-imprvious part, the result should be corrected</span>
        <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;CSL&quot;</span><span class="p">:</span>
        <span class="n">qt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="n">qs_</span> <span class="o">=</span> <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">qt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
            <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lag</span><span class="p">):</span>
                <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">qs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">qt</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">lag</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;MZ&quot;</span><span class="p">:</span>
        <span class="n">rout_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">rout_b</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">rout_a</span><span class="p">,</span> <span class="n">rout_b</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">)</span>
        <span class="n">qs_</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">,</span> <span class="n">conv_uh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CS&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="c1"># seq, batch, feature</span>
    <span class="n">q_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span>
    <span class="k">return</span> <span class="n">q_sim</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../hymod/" class="btn btn-neutral float-left" title="hymod"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../xaj_river/" class="btn btn-neutral float-right" title="xaj_river">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../hymod/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../xaj_river/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../../../../../../..';</script>
    <script src="../../../../../../../../js/theme_extra.js" defer></script>
    <script src="../../../../../../../../js/theme.js" defer></script>
      <script src="../../../../../../../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
